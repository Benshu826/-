# One Wire通信时序图详解

## 1. 完整通信时序图

### 主机发送开始信号阶段
```
时间轴 (us)
0    5    10   15   20   25   30   35   40   45   50
│    │    │    │    │    │    │    │    │    │    │
┌────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┐
│                                                         │
│  ┌─────────────────────────────────────────────────────┐ │
│  │ 主机输出模式                                        │ │
│  └─────────────────────────────────────────────────────┘ │
│                                                         │
│  ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐ │
│  │ │    │ │    │ │    │ │    │ │    │ │    │ │    │ │ │
────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────
    │<30us>│<18ms>│<30us>│
    │      │      │      │
    └─主机拉高    └─主机拉低    └─主机拉高
                │
                └─切换为输入模式
```

### DHT11响应阶段
```
时间轴 (us)
0    20   40   60   80   100  120  140  160  180  200
│    │    │    │    │    │    │    │    │    │    │
┌────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┐
│                                                         │
│  ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐ │
│  │ │    │ │    │ │    │ │    │ │    │ │    │ │    │ │ │
────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────
    │<80us>│<80us>│
    │      │      │
    └─DHT11拉低    └─DHT11拉高
```

### 数据传输阶段（单字节）
```
时间轴 (us)
0    10   20   30   40   50   60   70   80   90   100  110  120
│    │    │    │    │    │    │    │    │    │    │    │    │
┌────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┐
│                                                                   │
│  ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐   │
│  │ │    │ │    │ │    │ │    │ │    │ │    │ │    │ │    │ │   │
────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────
    │<50us>│<26-28us>│
    │      │         │
    └─低电平起始     └─数据0

    ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐    ┌─┐   │
    │ │    │ │    │ │    │ │    │ │    │ │    │ │    │ │    │ │   │
────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────┘ └────
    │<50us>│<70us>│
    │      │       │
    └─低电平起始    └─数据1
```

## 2. 详细时序分析

### 阶段1：主机发送开始信号
```
时序要求：
┌─────────────────────────────────────────────────────────┐
│ 步骤1：主机拉高数据线                                  │
│ 延时：30us                                            │
├─────────────────────────────────────────────────────────┤
│ 步骤2：主机拉低数据线                                  │
│ 延时：至少18ms（实际20ms）                             │
├─────────────────────────────────────────────────────────┤
│ 步骤3：主机拉高数据线                                  │
│ 延时：20-40us（实际30us）                             │
├─────────────────────────────────────────────────────────┤
│ 步骤4：主机切换为输入模式                              │
│ 准备接收DHT11响应                                     │
└─────────────────────────────────────────────────────────┘
```

### 阶段2：DHT11响应信号
```
时序要求：
┌─────────────────────────────────────────────────────────┐
│ 步骤1：DHT11拉低数据线                                │
│ 延时：80us                                            │
├─────────────────────────────────────────────────────────┤
│ 步骤2：DHT11拉高数据线                                │
│ 延时：80us                                            │
├─────────────────────────────────────────────────────────┤
│ 步骤3：DHT11开始发送数据                              │
│ 准备传输40位数据（5字节）                             │
└─────────────────────────────────────────────────────────┘
```

### 阶段3：数据传输
```
数据位时序：
┌─────────────────────────────────────────────────────────┐
│ 数据0：                                              │
│ ┌─┐    ┌─┐                                          │
│ │ │    │ │                                          │
───┘ └────┘ └───                                      │
│ │<50us>│<26-28us>│                                  │
│ │      │         │                                  │
│ └─低电平起始     └─高电平（短）                      │
├─────────────────────────────────────────────────────────┤
│ 数据1：                                              │
│ ┌─┐    ┌─┐                                          │
│ │ │    │ │                                          │
───┘ └────┘ └───                                      │
│ │<50us>│<70us>│                                     │
│ │      │      │                                     │
│ └─低电平起始    └─高电平（长）                       │
└─────────────────────────────────────────────────────────┘
```

## 3. 数据包结构

### 40位数据包格式
```
位39-32  位31-24  位23-16  位15-8   位7-0
┌────────┐┌────────┐┌────────┐┌────────┐┌────────┐
│湿度整数││湿度小数││温度整数││温度小数││校验和  │
│(8位)   ││(8位)   ││(8位)   ││(8位)   ││(8位)   │
└────────┘└────────┘└────────┘└────────┘└────────┘
```

### 数据解析示例
```
原始数据：0x23 0x01 0x16 0x00 0x3A
解析结果：
- 湿度整数：0x23 = 35%
- 湿度小数：0x01 = 0.1%
- 温度整数：0x16 = 22°C
- 温度小数：0x00 = 0.0°C
- 校验和：0x3A = 0x23+0x01+0x16+0x00 = 0x3A ✓
```

## 4. 关键时序参数

### 主机时序要求
```
参数名称        最小值    典型值    最大值    单位
主机拉低时间    18        20        -        ms
主机拉高时间    20        30        40        us
数据位低电平    50        50        50        us
数据位高电平    26        28        28        us (数据0)
数据位高电平    70        70        70        us (数据1)
```

### DHT11响应时序
```
参数名称        最小值    典型值    最大值    单位
DHT11拉低时间   80        80        80        us
DHT11拉高时间   80        80        80        us
数据位间隔      50        50        50        us
```

## 5. 通信流程图

```
开始
  │
  ▼
主机拉高数据线
  │
  ▼
延时30us
  │
  ▼
主机拉低数据线
  │
  ▼
延时20ms
  │
  ▼
主机拉高数据线
  │
  ▼
延时30us
  │
  ▼
主机切换为输入模式
  │
  ▼
等待DHT11拉低响应
  │
  ▼
等待DHT11拉高响应
  │
  ▼
接收40位数据
  │
  ▼
数据校验
  │
  ▼
结束
```

## 6. 错误处理机制

### 常见错误类型
```
错误类型          原因                解决方法
超时错误          设备未响应          检查连接和电源
数据校验失败      通信干扰            重新发送开始信号
时序错误          延时不准确          调整延时函数
电平错误          GPIO配置错误        检查GPIO设置
```

### 错误恢复策略
```
1. 重新发送开始信号
2. 增加延时时间
3. 检查硬件连接
4. 降低通信频率
5. 添加重试机制
```

## 7. 调试建议

### 示波器观察要点
- **开始信号：** 检查18ms低电平和30us高电平
- **响应信号：** 确认80us低电平和80us高电平
- **数据位：** 区分26-28us和70us高电平
- **整体时序：** 确保各阶段时序正确

### 逻辑分析仪设置
- **采样率：** 至少1MHz
- **触发条件：** 下降沿触发
- **观察时间：** 至少100ms
- **通道设置：** 数据线 + 时钟参考

这个时序图详细展示了One Wire协议的完整通信过程，包括主机发送开始信号、DHT11响应和数据传输的每个阶段。 